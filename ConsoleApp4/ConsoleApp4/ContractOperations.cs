using System;
using System.Collections.Generic;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using Nethereum.Contracts;
using Nethereum.Hex.HexTypes;
using Nethereum.RPC.Eth.DTOs;
using Nethereum.Util;
using Nethereum.Web3;
using Nethereum.Web3.Accounts;

namespace ConsoleApp4
{
    public class ContractOperations
    {
        public static string _abi= @"[

    {
                ""constant"": false,
		""inputs"": [
			{
				""name"": ""account"",
				""type"": ""address""

            },
			{
				""name"": ""counter"",
				""type"": ""uint64""
			}
		],
		""name"": ""insertSensorData"",
		""outputs"": [],
		""payable"": false,
		""stateMutability"": ""nonpayable"",
		""type"": ""function""
	},
	{
		""constant"": false,
		""inputs"": [
			{
				""name"": ""userAddress"",
				""type"": ""address""
			},
			{
				""name"": ""email"",
				""type"": ""bytes32""
			},
			{
				""name"": ""age"",
				""type"": ""uint256""
			}
		],
		""name"": ""insertUser"",
		""outputs"": [
			{
				""name"": ""index"",
				""type"": ""uint256""
			}
		],
		""payable"": false,
		""stateMutability"": ""nonpayable"",
		""type"": ""function""
	},
	{
		""constant"": false,
		""inputs"": [
			{
				""name"": ""zone_id"",
				""type"": ""uint8""
			},
			{
				""name"": ""rate_per_1000"",
				""type"": ""uint32""
			}
		],
		""name"": ""loadTariffZone"",
		""outputs"": [],
		""payable"": false,
		""stateMutability"": ""nonpayable"",
		""type"": ""function""
	},
	{
		""constant"": true,
		""inputs"": [
			{
				""name"": ""account"",
				""type"": ""address""
			}
		],
		""name"": ""getSensor"",
		""outputs"": [
			{
				""name"": ""s_account"",
				""type"": ""address""
			},
			{
				""name"": ""s_zone_id"",
				""type"": ""uint8""
			},
			{
				""name"": ""s_title"",
				""type"": ""string""
			},
			{
				""name"": ""sdata_length"",
				""type"": ""uint64""
			}
		],
		""payable"": false,
		""stateMutability"": ""view"",
		""type"": ""function""
	},
	{
		""constant"": false,
		""inputs"": [],
		""name"": ""incrementCounter"",
		""outputs"": [],
		""payable"": false,
		""stateMutability"": ""nonpayable"",
		""type"": ""function""
	},
	{
		""constant"": true,
		""inputs"": [
			{
				""name"": ""userAddress"",
				""type"": ""address""
			}
		],
		""name"": ""getUser"",
		""outputs"": [
			{
				""name"": ""userEmail"",
				""type"": ""string""
			},
			{
				""name"": ""userAge"",
				""type"": ""uint256""
			},
			{
				""name"": ""index"",
				""type"": ""uint256""
			}
		],
		""payable"": false,
		""stateMutability"": ""view"",
		""type"": ""function""
	},
	{
		""constant"": true,
		""inputs"": [],
		""name"": ""getTariffZones"",
		""outputs"": [
			{
				""name"": """",
				""type"": ""uint32""
			}
		],
		""payable"": false,
		""stateMutability"": ""view"",
		""type"": ""function""
	},
	{
		""constant"": true,
		""inputs"": [
			{
				""name"": ""account"",
				""type"": ""address""
			},
			{
				""name"": ""index"",
				""type"": ""uint64""
			}
		],
		""name"": ""getSensorData"",
		""outputs"": [
			{
				""name"": """",
				""type"": ""uint64""
			},
			{
				""name"": """",
				""type"": ""uint256""
			},
			{
				""name"": """",
				""type"": ""uint64""
			}
		],
		""payable"": false,
		""stateMutability"": ""view"",
		""type"": ""function""
	},
	{
		""constant"": false,
		""inputs"": [
			{
				""name"": ""x"",
				""type"": ""bytes32""
			}
		],
		""name"": ""bytes32ToString"",
		""outputs"": [
			{
				""name"": """",
				""type"": ""string""
			}
		],
		""payable"": false,
		""stateMutability"": ""nonpayable"",
		""type"": ""function""
	},
	{
		""constant"": true,
		""inputs"": [],
		""name"": ""getCount"",
		""outputs"": [
			{
				""name"": """",
				""type"": ""int256""
			}
		],
		""payable"": false,
		""stateMutability"": ""view"",
		""type"": ""function""
	},
	{
		""constant"": true,
		""inputs"": [
			{
				""name"": ""zone_id"",
				""type"": ""uint8""
			}
		],
		""name"": ""getTariffZoneByZoneId"",
		""outputs"": [
			{
				""name"": """",
				""type"": ""uint32""
			}
		],
		""payable"": false,
		""stateMutability"": ""view"",
		""type"": ""function""
	},
	{
		""constant"": false,
		""inputs"": [
			{
				""name"": ""account"",
				""type"": ""address""
			},
			{
				""name"": ""zone_id"",
				""type"": ""uint8""
			},
			{
				""name"": ""title"",
				""type"": ""string""
			}
		],
		""name"": ""insertSensor"",
		""outputs"": [],
		""payable"": false,
		""stateMutability"": ""nonpayable"",
		""type"": ""function""
	},
	{
		""constant"": false,
		""inputs"": [],
		""name"": ""decrementCounter"",
		""outputs"": [],
		""payable"": false,
		""stateMutability"": ""nonpayable"",
		""type"": ""function""
	},
	{
		""inputs"": [],
		""payable"": false,
		""stateMutability"": ""nonpayable"",
		""type"": ""constructor""
	}
]";
        private readonly string _url;
        private readonly string _privateKey;
        private readonly string _contractAddress;
        private readonly Web3 _web3;
        private readonly Account _account;
        private readonly Contract _contract;

        public static string _contractByteCode = "0x608060405260008060006101000a81548160ff021916908315150217905550600060055534801561002f57600080fd5b5060008060006101000a81548160ff02191690831515021790555060008060016101000a81548163ffffffff021916908363ffffffff1602179055506116188061007a6000396000f3fe6080604052600436106100bf576000357c0100000000000000000000000000000000000000000000000000000000900480631931e3f1146100c457806329434e33146100ed5780632cb527aa1461012a5780634798639c146101535780635b34b966146101935780636f77926b146101aa5780637413ce99146101e9578063913308e8146102145780639201de5514610253578063a87d942c14610290578063c06c6511146102bb578063ed63ccbb146102f8578063f5c5ad8314610321575b600080fd5b3480156100d057600080fd5b506100eb60048036036100e69190810190611164565b610338565b005b3480156100f957600080fd5b50610114600480360361010f9190810190611115565b6104ef565b60405161012191906113ec565b60405180910390f35b34801561013657600080fd5b50610151600480360361014c9190810190611259565b610657565b005b34801561015f57600080fd5b5061017a600480360361017591908101906110ec565b6106e4565b60405161018a9493929190611325565b60405180910390f35b34801561019f57600080fd5b506101a86108e2565b005b3480156101b657600080fd5b506101d160048036036101cc91908101906110ec565b6108f5565b6040516101e0939291906113ae565b60405180910390f35b3480156101f557600080fd5b506101fe610a6b565b60405161020b9190611407565b60405180910390f35b34801561022057600080fd5b5061023b60048036036102369190810190611164565b610a84565b60405161024a93929190611422565b60405180910390f35b34801561025f57600080fd5b5061027a60048036036102759190810190611207565b610b81565b604051610287919061138c565b60405180910390f35b34801561029c57600080fd5b506102a5610d87565b6040516102b29190611371565b60405180910390f35b3480156102c757600080fd5b506102e260048036036102dd9190810190611230565b610d91565b6040516102ef9190611407565b60405180910390f35b34801561030457600080fd5b5061031f600480360361031a91908101906111a0565b610dc4565b005b34801561032d57600080fd5b50610336610f66565b005b600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206003016060604051908101604052808473ffffffffffffffffffffffffffffffffffffffff1681526020018367ffffffffffffffff168152602001428152509080600181540180825580915050906001820390600052602060002090600202016000909192909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160000160146101000a81548167ffffffffffffffff021916908367ffffffffffffffff16021790555060408201518160010155505050600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600201600081819054906101000a900467ffffffffffffffff168092919060010191906101000a81548167ffffffffffffffff021916908367ffffffffffffffff160217905550505050565b60006104fa83610b81565b600360008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001908051906020019061054f929190610f79565b5081600360008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010181905550600160048590806001815401808255809150509060018203906000526020600020016000909192909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555003600360008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206002018190555060016004805490500390509392505050565b80600160008460ff1660ff16815260200190815260200160002060006101000a81548163ffffffff021916908363ffffffff1602179055506001600060018282829054906101000a900463ffffffff160192506101000a81548163ffffffff021916908363ffffffff16021790555060016000806101000a81548160ff0219169083151502179055505050565b60008060606000600260008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600260008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160149054906101000a900460ff16600260008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101600260008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160009054906101000a900467ffffffffffffffff16818054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108cc5780601f106108a1576101008083540402835291602001916108cc565b820191906000526020600020905b8154815290600101906020018083116108af57829003601f168201915b5050505050915093509350935093509193509193565b6001600560008282540192505081905550565b6060600080600360008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001600360008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010154600360008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020154828054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610a575780601f10610a2c57610100808354040283529160200191610a57565b820191906000526020600020905b815481529060010190602001808311610a3a57829003601f168201915b505050505092509250925092509193909250565b60008060019054906101000a900463ffffffff16905090565b6000806000600260008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206003018467ffffffffffffffff16815481101515610ae257fe5b906000526020600020906002020160000160149054906101000a900467ffffffffffffffff16600260008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206003018567ffffffffffffffff16815481101515610b6157fe5b906000526020600020906002020160010154859250925092509250925092565b60608060206040519080825280601f01601f191660200182016040528015610bb85781602001600182028038833980820191505090505b509050600080905060008090505b6020811015610c875760008160080260020a866001900402600102905060007f010000000000000000000000000000000000000000000000000000000000000002817effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916141515610c7957808484815181101515610c4057fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535082806001019350505b508080600101915050610bc6565b506060816040519080825280601f01601f191660200182016040528015610cbd5781602001600182028038833980820191505090505b50905060008090505b828160ff161015610d7b57838160ff16815181101515610ce257fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f010000000000000000000000000000000000000000000000000000000000000002828260ff16815181101515610d3e57fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053508080600101915050610cc6565b50809350505050919050565b6000600554905090565b6000600160008360ff1660ff16815260200190815260200160002060009054906101000a900463ffffffff169050919050565b82600260008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555081600260008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160146101000a81548160ff021916908360ff16021790555080600260008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206001019080519060200190610ef6929190610f79565b506000600260008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160006101000a81548167ffffffffffffffff021916908367ffffffffffffffff160217905550505050565b6001600560008282540392505081905550565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610fba57805160ff1916838001178555610fe8565b82800160010185558215610fe8579182015b82811115610fe7578251825591602001919060010190610fcc565b5b509050610ff59190610ff9565b5090565b61101b91905b80821115611017576000816000905550600101610fff565b5090565b90565b600061102a8235611534565b905092915050565b600061103e8235611546565b905092915050565b600082601f830112151561105957600080fd5b813561106c61106782611486565b611459565b9150808252602083016020830185838301111561108857600080fd5b61109383828461158b565b50505092915050565b60006110a88235611550565b905092915050565b60006110bc823561155a565b905092915050565b60006110d0823561156a565b905092915050565b60006110e4823561157e565b905092915050565b6000602082840312156110fe57600080fd5b600061110c8482850161101e565b91505092915050565b60008060006060848603121561112a57600080fd5b60006111388682870161101e565b935050602061114986828701611032565b925050604061115a8682870161109c565b9150509250925092565b6000806040838503121561117757600080fd5b60006111858582860161101e565b9250506020611196858286016110c4565b9150509250929050565b6000806000606084860312156111b557600080fd5b60006111c38682870161101e565b93505060206111d4868287016110d8565b925050604084013567ffffffffffffffff8111156111f157600080fd5b6111fd86828701611046565b9150509250925092565b60006020828403121561121957600080fd5b600061122784828501611032565b91505092915050565b60006020828403121561124257600080fd5b6000611250848285016110d8565b91505092915050565b6000806040838503121561126c57600080fd5b600061127a858286016110d8565b925050602061128b858286016110b0565b9150509250929050565b61129e816114bd565b82525050565b6112ad816114cf565b82525050565b60006112be826114b2565b8084526112d281602086016020860161159a565b6112db816115cd565b602085010191505092915050565b6112f2816114f9565b82525050565b61130181611503565b82525050565b61131081611513565b82525050565b61131f81611527565b82525050565b600060808201905061133a6000830187611295565b6113476020830186611316565b818103604083015261135981856112b3565b90506113686060830184611307565b95945050505050565b600060208201905061138660008301846112a4565b92915050565b600060208201905081810360008301526113a681846112b3565b905092915050565b600060608201905081810360008301526113c881866112b3565b90506113d760208301856112e9565b6113e460408301846112e9565b949350505050565b600060208201905061140160008301846112e9565b92915050565b600060208201905061141c60008301846112f8565b92915050565b60006060820190506114376000830186611307565b61144460208301856112e9565b6114516040830184611307565b949350505050565b6000604051905081810181811067ffffffffffffffff8211171561147c57600080fd5b8060405250919050565b600067ffffffffffffffff82111561149d57600080fd5b601f19601f8301169050602081019050919050565b600081519050919050565b60006114c8826114d9565b9050919050565b6000819050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600063ffffffff82169050919050565b600067ffffffffffffffff82169050919050565b600060ff82169050919050565b600061153f826114d9565b9050919050565b6000819050919050565b6000819050919050565b600063ffffffff82169050919050565b600067ffffffffffffffff82169050919050565b600060ff82169050919050565b82818337600083830152505050565b60005b838110156115b857808201518184015260208101905061159d565b838111156115c7576000848401525b50505050565b6000601f19601f830116905091905056fea265627a7a7230582002ea4ae8544fe4a85565ca52235635e471d864fe651057b5e97afe827fadce5b6c6578706572696d656e74616cf50037";
        
        public ContractOperations(string url, string privateKey, string contractAddress)
        {
            _url = url;

            _privateKey = privateKey;

            _contractAddress = contractAddress;

            _account = new Nethereum.Web3.Accounts.Account(privateKey);

            _web3 = new Web3(_account, url);

            _contract = _web3.Eth.GetContract(_abi, contractAddress);

        }

        public Contract Contract => _contract;

        public Web3 Web3 => _web3;

        public Account Account => _account;


        public async Task<int> GetTariffZones()
        {
           return await _contract.GetFunction("getTariffZones").CallAsync<int>();
        }
        //loadTariffZone
        public async Task<TransactionReceipt> LoadTariffZone(int zoneId, long ratePer1000)
        {
            var f =  _contract.GetFunction("loadTariffZone");

            //var receipt = web3.Eth.DeployContract.SendRequestAndWaitForReceiptAsync(
            //    ContractOperations._abi,
            //    ContractOperations._contractByteCode,
            //    senderAddress,
            //    new Nethereum.Hex.HexTypes.HexBigInteger(2000000),
            //    //0,
            //    default)

            return await f.SendTransactionAndWaitForReceiptAsync("0x8364d57F6511771CBe20aaf1CF8dA73a9B487F3f", new Nethereum.Hex.HexTypes.HexBigInteger(2000000),new HexBigInteger(0),default, zoneId, ratePer1000);
        }
    }
}
